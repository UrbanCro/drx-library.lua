-- D.R.X UI Library - FIXED
-- Fixes:
--   1. Keybinds now have GetValue/SetValue unified with toggle/slider so save works
--   2. File operation checks fixed for all major executors (Synapse, KRNL, Fluxus, Solara, Wave)
--   3. Config load now correctly restores all element types
--   4. SavedConfigs list updates reliably after save/delete

local Library = {}

local CoreGui          = game:GetService("CoreGui")
local TweenService     = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService      = game:GetService("HttpService")

if CoreGui:FindFirstChild("DRXGUI") then
    CoreGui:FindFirstChild("DRXGUI"):Destroy()
    task.wait(0.1)
end

local Colors = {
    Background    = Color3.fromRGB(18,  18,  22),
    Surface       = Color3.fromRGB(25,  25,  30),
    Elevated      = Color3.fromRGB(32,  32,  38),
    Primary       = Color3.fromRGB(100, 100, 255),
    Success       = Color3.fromRGB(34,  197, 94),
    Error         = Color3.fromRGB(239, 68,  68),
    TextPrimary   = Color3.fromRGB(255, 255, 255),
    TextSecondary = Color3.fromRGB(156, 163, 175),
    Border        = Color3.fromRGB(45,  45,  52),
}

local function Corner(parent, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 12)
    c.Parent = parent
    return c
end

local function Tween(obj, props, dur, style, dir)
    TweenService:Create(obj,
        TweenInfo.new(dur or 0.3, style or Enum.EasingStyle.Quint, dir or Enum.EasingDirection.Out),
        props):Play()
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- FILE SYSTEM ‚Äî executor-safe wrappers
-- Works with: Synapse X, KRNL, Fluxus, Solara, Wave,
--             Script-Ware, Evon, and most others
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
local SaveFolder = "DRX_Configs"

-- Safely check if a function global actually exists and is callable
local function hasFunc(name)
    local ok, val = pcall(function() return _G[name] or getfenv()[name] end)
    return ok and type(val) == "function"
end

-- Use the correct file-exists method for this executor
local function fileExists(path)
    -- Most executors: isfile()
    if isfile then
        local ok, result = pcall(isfile, path)
        if ok then return result end
    end
    -- Fallback: try reading it
    if readfile then
        local ok = pcall(readfile, path)
        return ok
    end
    return false
end

local function folderExists(path)
    if isfolder then
        local ok, result = pcall(isfolder, path)
        if ok then return result end
    end
    return false
end

local function ensureFolder(path)
    if not folderExists(path) then
        if makefolder then
            pcall(makefolder, path)
        end
    end
end

local function writeFile(path, content)
    if not writefile then return false end
    local ok, err = pcall(writefile, path, content)
    if not ok then warn("DRX writefile error:", err) end
    return ok
end

local function readFile(path)
    if not readfile then return nil end
    local ok, data = pcall(readfile, path)
    return ok and data or nil
end

local function deleteFile(path)
    if not delfile then return false end
    local ok = pcall(delfile, path)
    return ok
end

local function listFiles(path)
    if not listfiles then return {} end
    local ok, files = pcall(listfiles, path)
    return (ok and files) or {}
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- SAVE / LOAD  (fixed)
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
local function SaveConfig(name, data)
    ensureFolder(SaveFolder)
    local ok, encoded = pcall(HttpService.JSONEncode, HttpService, data)
    if not ok then warn("DRX JSON encode error:", encoded) return false end
    return writeFile(SaveFolder .. "/" .. name .. ".txt", encoded)
end

local function LoadConfig(name)
    local raw = readFile(SaveFolder .. "/" .. name .. ".txt")
    if not raw then return nil end
    local ok, data = pcall(HttpService.JSONDecode, HttpService, raw)
    return ok and data or nil
end

local function DeleteConfig(name)
    return deleteFile(SaveFolder .. "/" .. name .. ".txt")
end

local function GetConfigList()
    ensureFolder(SaveFolder)
    local files = listFiles(SaveFolder)
    local names = {}
    for _, f in ipairs(files) do
        -- f may be full path like "DRX_Configs/myconfig.txt" or just "myconfig.txt"
        local n = (f:match("([^/\\]+)$") or f):gsub("%.txt$", "")
        if n and n ~= "" then
            table.insert(names, n)
        end
    end
    return names
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- WINDOW
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function Library:CreateWindow(title)
    local Window       = {}
    Window.Tabs        = {}
    Window.ConfigValues= {}   -- [key] = element with GetValue/SetValue/TriggerCallback
    Window.ToggleKey   = nil

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name           = "DRXGUI"
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.ResetOnSpawn   = false
    ScreenGui.IgnoreGuiInset = true
    ScreenGui.Parent         = CoreGui

    local Main = Instance.new("Frame")
    Main.Name             = "MainContainer"
    Main.AnchorPoint      = Vector2.new(0.5, 0.5)
    Main.Position         = UDim2.new(0.5, 0, 0.5, 0)
    Main.Size             = UDim2.new(0, 650, 0, 450)
    Main.BackgroundColor3 = Colors.Background
    Main.BorderSizePixel  = 0
    Main.Parent           = ScreenGui
    Corner(Main, 12)

    local MainStroke = Instance.new("UIStroke")
    MainStroke.Color     = Colors.Border
    MainStroke.Thickness = 1
    MainStroke.Parent    = Main

    -- Top bar
    local TopBar = Instance.new("Frame")
    TopBar.Name             = "TopBar"
    TopBar.Size             = UDim2.new(1, 0, 0, 50)
    TopBar.BackgroundColor3 = Colors.Surface
    TopBar.BorderSizePixel  = 0
    TopBar.Parent           = Main
    Corner(TopBar, 12)

    local TopCover = Instance.new("Frame")
    TopCover.Size             = UDim2.new(1, 0, 0, 12)
    TopCover.Position         = UDim2.new(0, 0, 1, -12)
    TopCover.BackgroundColor3 = Colors.Surface
    TopCover.BorderSizePixel  = 0
    TopCover.Parent           = TopBar

    local TitleLbl = Instance.new("TextLabel")
    TitleLbl.Size             = UDim2.new(1, -40, 1, 0)
    TitleLbl.Position         = UDim2.new(0, 20, 0, 0)
    TitleLbl.BackgroundTransparency = 1
    TitleLbl.Font             = Enum.Font.GothamBold
    TitleLbl.Text             = title or "D.R.X"
    TitleLbl.TextColor3       = Colors.TextPrimary
    TitleLbl.TextSize         = 18
    TitleLbl.TextXAlignment   = Enum.TextXAlignment.Left
    TitleLbl.Parent           = TopBar

    -- Sidebar
    local Sidebar = Instance.new("Frame")
    Sidebar.Name             = "Sidebar"
    Sidebar.Size             = UDim2.new(0, 160, 1, -65)
    Sidebar.Position         = UDim2.new(0, 12, 0, 60)
    Sidebar.BackgroundColor3 = Colors.Surface
    Sidebar.BorderSizePixel  = 0
    Sidebar.Parent           = Main
    Corner(Sidebar, 10)

    local TabList = Instance.new("UIListLayout")
    TabList.Padding             = UDim.new(0, 6)
    TabList.SortOrder           = Enum.SortOrder.LayoutOrder
    TabList.HorizontalAlignment = Enum.HorizontalAlignment.Center
    TabList.Parent              = Sidebar

    local SidebarPad = Instance.new("UIPadding")
    SidebarPad.PaddingTop    = UDim.new(0, 12)
    SidebarPad.PaddingBottom = UDim.new(0, 12)
    SidebarPad.Parent        = Sidebar

    -- Content
    local ContentArea = Instance.new("Frame")
    ContentArea.Name                  = "ContentArea"
    ContentArea.Size                  = UDim2.new(1, -190, 1, -65)
    ContentArea.Position              = UDim2.new(0, 182, 0, 60)
    ContentArea.BackgroundTransparency= 1
    ContentArea.BorderSizePixel       = 0
    ContentArea.Parent                = Main

    -- ‚îÄ‚îÄ Element Creators ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    local function CreateButton(parent, text, callback)
        local Btn = Instance.new("TextButton")
        Btn.Size             = UDim2.new(1, 0, 0, 38)
        Btn.BackgroundColor3 = Colors.Elevated
        Btn.BorderSizePixel  = 0
        Btn.Font             = Enum.Font.Gotham
        Btn.Text             = text
        Btn.TextColor3       = Colors.TextPrimary
        Btn.TextSize         = 13
        Btn.AutoButtonColor  = false
        Btn.Parent           = parent
        Corner(Btn, 8)
        Btn.MouseEnter:Connect(function() Tween(Btn, {BackgroundColor3 = Colors.Primary},  0.2) end)
        Btn.MouseLeave:Connect(function() Tween(Btn, {BackgroundColor3 = Colors.Elevated}, 0.2) end)
        Btn.MouseButton1Click:Connect(function() if callback then pcall(callback) end end)
        return Btn
    end

    local function CreateToggle(parent, text, default, callback)
        local state = default or false

        local Container = Instance.new("Frame")
        Container.Size             = UDim2.new(1, 0, 0, 38)
        Container.BackgroundColor3 = Colors.Elevated
        Container.BorderSizePixel  = 0
        Container.Parent           = parent
        Corner(Container, 8)

        local Lbl = Instance.new("TextLabel")
        Lbl.Size             = UDim2.new(1, -60, 1, 0)
        Lbl.Position         = UDim2.new(0, 12, 0, 0)
        Lbl.BackgroundTransparency = 1
        Lbl.Font             = Enum.Font.Gotham
        Lbl.Text             = text
        Lbl.TextColor3       = Colors.TextPrimary
        Lbl.TextSize         = 13
        Lbl.TextXAlignment   = Enum.TextXAlignment.Left
        Lbl.Parent           = Container

        local Back = Instance.new("Frame")
        Back.Size             = UDim2.new(0, 42, 0, 22)
        Back.Position         = UDim2.new(1, -50, 0.5, 0)
        Back.AnchorPoint      = Vector2.new(0, 0.5)
        Back.BackgroundColor3 = state and Colors.Success or Colors.Surface
        Back.BorderSizePixel  = 0
        Back.Parent           = Container
        Corner(Back, 11)

        local Knob = Instance.new("Frame")
        Knob.Size             = UDim2.new(0, 18, 0, 18)
        Knob.Position         = state and UDim2.new(1, -20, 0.5, 0) or UDim2.new(0, 2, 0.5, 0)
        Knob.AnchorPoint      = Vector2.new(0, 0.5)
        Knob.BackgroundColor3 = Colors.TextPrimary
        Knob.BorderSizePixel  = 0
        Knob.Parent           = Back
        Corner(Knob, 9)

        local ClickBtn = Instance.new("TextButton")
        ClickBtn.Size                  = UDim2.new(1, 0, 1, 0)
        ClickBtn.BackgroundTransparency= 1
        ClickBtn.Text                  = ""
        ClickBtn.Parent                = Back

        ClickBtn.MouseButton1Click:Connect(function()
            state = not state
            Tween(Back, {BackgroundColor3 = state and Colors.Success or Colors.Surface}, 0.2)
            Tween(Knob, {Position = state and UDim2.new(1,-20,0.5,0) or UDim2.new(0,2,0.5,0)}, 0.2)
            if callback then pcall(callback, state) end
        end)

        -- Unified API ‚Äî GetValue/SetValue so save works same as slider
        return {
            GetValue = function() return state end,
            SetValue = function(val, trigger)
                state = val
                Back.BackgroundColor3 = state and Colors.Success or Colors.Surface
                Knob.Position = state and UDim2.new(1,-20,0.5,0) or UDim2.new(0,2,0.5,0)
                if trigger and callback then pcall(callback, state) end
            end,
            TriggerCallback = function()
                if callback then pcall(callback, state) end
            end,
        }
    end

    local function CreateSlider(parent, text, min, max, default, callback)
        local currentValue = default

        local Container = Instance.new("Frame")
        Container.Size             = UDim2.new(1, 0, 0, 55)
        Container.BackgroundColor3 = Colors.Elevated
        Container.BorderSizePixel  = 0
        Container.Parent           = parent
        Corner(Container, 8)

        local Lbl = Instance.new("TextLabel")
        Lbl.Size           = UDim2.new(1, -60, 0, 20)
        Lbl.Position       = UDim2.new(0, 12, 0, 6)
        Lbl.BackgroundTransparency = 1
        Lbl.Font           = Enum.Font.Gotham
        Lbl.Text           = text
        Lbl.TextColor3     = Colors.TextPrimary
        Lbl.TextSize       = 13
        Lbl.TextXAlignment = Enum.TextXAlignment.Left
        Lbl.Parent         = Container

        local ValLbl = Instance.new("TextLabel")
        ValLbl.Size           = UDim2.new(0, 50, 0, 20)
        ValLbl.Position       = UDim2.new(1, -56, 0, 6)
        ValLbl.BackgroundTransparency = 1
        ValLbl.Font           = Enum.Font.GothamBold
        ValLbl.Text           = tostring(default)
        ValLbl.TextColor3     = Colors.Primary
        ValLbl.TextSize       = 13
        ValLbl.TextXAlignment = Enum.TextXAlignment.Right
        ValLbl.Parent         = Container

        local Track = Instance.new("Frame")
        Track.Size             = UDim2.new(1, -24, 0, 4)
        Track.Position         = UDim2.new(0, 12, 1, -16)
        Track.BackgroundColor3 = Colors.Surface
        Track.BorderSizePixel  = 0
        Track.Parent           = Container
        Corner(Track, 2)

        local Fill = Instance.new("Frame")
        Fill.Size             = UDim2.new((default - min) / (max - min), 0, 1, 0)
        Fill.BackgroundColor3 = Colors.Primary
        Fill.BorderSizePixel  = 0
        Fill.Parent           = Track
        Corner(Fill, 2)

        local Knob = Instance.new("Frame")
        Knob.Size             = UDim2.new(0, 16, 0, 16)
        Knob.Position         = UDim2.new((default - min) / (max - min), 0, 0.5, 0)
        Knob.AnchorPoint      = Vector2.new(0.5, 0.5)
        Knob.BackgroundColor3 = Colors.TextPrimary
        Knob.BorderSizePixel  = 0
        Knob.Parent           = Track
        Corner(Knob, 8)

        local dragging = false

        local function Update(input)
            local pos = math.clamp((input.Position.X - Track.AbsolutePosition.X) / Track.AbsoluteSize.X, 0, 1)
            currentValue = math.floor(min + pos * (max - min))
            ValLbl.Text    = tostring(currentValue)
            Fill.Size      = UDim2.new(pos, 0, 1, 0)
            Knob.Position  = UDim2.new(pos, 0, 0.5, 0)
            if callback then pcall(callback, currentValue) end
        end

        Track.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging=true Update(i) end end)
        Knob.InputBegan:Connect(function(i)  if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging=true Update(i) end end)
        UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging=false end end)
        UserInputService.InputChanged:Connect(function(i) if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then Update(i) end end)

        return {
            GetValue = function() return currentValue end,
            SetValue = function(val, trigger)
                currentValue = math.floor(math.clamp(val, min, max))
                local pos = (currentValue - min) / (max - min)
                ValLbl.Text   = tostring(currentValue)
                Fill.Size     = UDim2.new(pos, 0, 1, 0)
                Knob.Position = UDim2.new(pos, 0, 0.5, 0)
                if trigger and callback then pcall(callback, currentValue) end
            end,
            TriggerCallback = function()
                if callback then pcall(callback, currentValue) end
            end,
        }
    end

    local function CreateLabel(parent, text)
        local Lbl = Instance.new("TextLabel")
        Lbl.Size             = UDim2.new(1, 0, 0, 32)
        Lbl.BackgroundColor3 = Colors.Elevated
        Lbl.BorderSizePixel  = 0
        Lbl.Font             = Enum.Font.GothamBold
        Lbl.Text             = text
        Lbl.TextColor3       = Colors.TextPrimary
        Lbl.TextSize         = 13
        Lbl.TextXAlignment   = Enum.TextXAlignment.Left
        Lbl.Parent           = parent
        Corner(Lbl, 8)
        local p = Instance.new("UIPadding") p.PaddingLeft = UDim.new(0,12) p.Parent = Lbl
        return { SetText = function(t) Lbl.Text = t end }
    end

    local function CreateTextbox(parent, placeholder, callback)
        local Container = Instance.new("Frame")
        Container.Size             = UDim2.new(1, 0, 0, 38)
        Container.BackgroundColor3 = Colors.Elevated
        Container.BorderSizePixel  = 0
        Container.Parent           = parent
        Corner(Container, 8)

        local Box = Instance.new("TextBox")
        Box.Size               = UDim2.new(1, -24, 1, 0)
        Box.Position           = UDim2.new(0, 12, 0, 0)
        Box.BackgroundTransparency = 1
        Box.Font               = Enum.Font.Gotham
        Box.PlaceholderText    = placeholder
        Box.PlaceholderColor3  = Colors.TextSecondary
        Box.Text               = ""
        Box.TextColor3         = Colors.TextPrimary
        Box.TextSize           = 13
        Box.TextXAlignment     = Enum.TextXAlignment.Left
        Box.ClearTextOnFocus   = false
        Box.Parent             = Container

        Box.FocusLost:Connect(function(enter)
            if enter and callback then pcall(callback, Box.Text) end
        end)

        return {
            GetText = function() return Box.Text end,
            SetText = function(t) Box.Text = t end,
            Clear   = function()  Box.Text = "" end,
        }
    end

    -- FIXED: Keybind now has GetValue/SetValue that mirror GetKey/SetKey
    -- so the config save/load system works identically to toggle and slider
    local function CreateKeybind(parent, text, default, callback)
        local currentKey = default or "None"

        local Container = Instance.new("Frame")
        Container.Size             = UDim2.new(1, 0, 0, 38)
        Container.BackgroundColor3 = Colors.Elevated
        Container.BorderSizePixel  = 0
        Container.Parent           = parent
        Corner(Container, 8)

        local Lbl = Instance.new("TextLabel")
        Lbl.Size           = UDim2.new(1, -100, 1, 0)
        Lbl.Position       = UDim2.new(0, 12, 0, 0)
        Lbl.BackgroundTransparency = 1
        Lbl.Font           = Enum.Font.Gotham
        Lbl.Text           = text
        Lbl.TextColor3     = Colors.TextPrimary
        Lbl.TextSize       = 13
        Lbl.TextXAlignment = Enum.TextXAlignment.Left
        Lbl.Parent         = Container

        local KeyBtn = Instance.new("TextButton")
        KeyBtn.Size             = UDim2.new(0, 85, 0, 28)
        KeyBtn.Position         = UDim2.new(1, -92, 0.5, 0)
        KeyBtn.AnchorPoint      = Vector2.new(0, 0.5)
        KeyBtn.BackgroundColor3 = Colors.Surface
        KeyBtn.BorderSizePixel  = 0
        KeyBtn.Font             = Enum.Font.GothamBold
        KeyBtn.Text             = currentKey
        KeyBtn.TextColor3       = Colors.Primary
        KeyBtn.TextSize         = 12
        KeyBtn.Parent           = Container
        Corner(KeyBtn, 6)

        local listening = false

        KeyBtn.MouseButton1Click:Connect(function()
            if listening then return end
            listening    = true
            KeyBtn.Text  = "..."
            local conn
            conn = UserInputService.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Keyboard then
                    currentKey  = input.KeyCode.Name
                    KeyBtn.Text = currentKey
                    listening   = false
                    conn:Disconnect()
                    if callback then pcall(callback, currentKey) end
                end
            end)
        end)

        -- GetValue/SetValue added so save system treats keybind same as all others
        return {
            GetKey   = function() return currentKey end,
            GetValue = function() return currentKey end,   -- FIX: unified for save
            SetKey   = function(key, trigger)
                currentKey  = key
                KeyBtn.Text = key
                if trigger and callback then pcall(callback, key) end
            end,
            SetValue = function(val, trigger)              -- FIX: unified for load
                currentKey  = val
                KeyBtn.Text = val
                if trigger and callback then pcall(callback, val) end
            end,
            TriggerCallback = function()
                if callback then pcall(callback, currentKey) end
            end,
        }
    end

    -- ‚îÄ‚îÄ Tab Creator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function Window:CreateTab(name, icon)
        local Tab = {}

        local TabBtn = Instance.new("TextButton")
        TabBtn.Name                  = name
        TabBtn.Size                  = UDim2.new(1, -16, 0, 38)
        TabBtn.BackgroundColor3      = Colors.Elevated
        TabBtn.BackgroundTransparency= 0.5
        TabBtn.BorderSizePixel       = 0
        TabBtn.Font                  = Enum.Font.Gotham
        TabBtn.Text                  = (icon or "üìÅ") .. " " .. name
        TabBtn.TextColor3            = Colors.TextSecondary
        TabBtn.TextSize              = 13
        TabBtn.TextXAlignment        = Enum.TextXAlignment.Left
        TabBtn.AutoButtonColor       = false
        TabBtn.LayoutOrder           = #Window.Tabs
        TabBtn.Parent                = Sidebar
        Corner(TabBtn, 8)

        local TabBtnPad = Instance.new("UIPadding")
        TabBtnPad.PaddingLeft = UDim.new(0, 12)
        TabBtnPad.Parent      = TabBtn

        local TabContent = Instance.new("ScrollingFrame")
        TabContent.Name                  = name .. "Content"
        TabContent.Size                  = UDim2.new(1, 0, 1, 0)
        TabContent.BackgroundTransparency= 1
        TabContent.BorderSizePixel       = 0
        TabContent.ScrollBarThickness    = 4
        TabContent.ScrollBarImageColor3  = Colors.Primary
        TabContent.CanvasSize            = UDim2.new(0, 0, 0, 0)
        TabContent.Visible               = false
        TabContent.Parent                = ContentArea

        local ContentList = Instance.new("UIListLayout")
        ContentList.Padding    = UDim.new(0, 10)
        ContentList.SortOrder  = Enum.SortOrder.LayoutOrder
        ContentList.Parent     = TabContent

        local ContentPad = Instance.new("UIPadding")
        ContentPad.PaddingTop    = UDim.new(0, 8)
        ContentPad.PaddingLeft   = UDim.new(0, 8)
        ContentPad.PaddingRight  = UDim.new(0, 12)
        ContentPad.PaddingBottom = UDim.new(0, 8)
        ContentPad.Parent        = TabContent

        ContentList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            TabContent.CanvasSize = UDim2.new(0, 0, 0, ContentList.AbsoluteContentSize.Y + 16)
        end)

        TabBtn.MouseButton1Click:Connect(function()
            for _, t in ipairs(Window.Tabs) do
                Tween(t.Button, {BackgroundTransparency=0.5, TextColor3=Colors.TextSecondary}, 0.2)
                t.Content.Visible = false
            end
            Tween(TabBtn, {BackgroundTransparency=0, TextColor3=Colors.TextPrimary}, 0.2)
            TabContent.Visible = true
        end)

        Tab.Button  = TabBtn
        Tab.Content = TabContent
        table.insert(Window.Tabs, Tab)

        -- Auto-select first non-config tab
        if #Window.Tabs == 1 then
            TabBtn.BackgroundTransparency = 0
            TabBtn.TextColor3             = Colors.TextPrimary
            TabContent.Visible            = true
        end

        function Tab:AddButton(text, cb)   return CreateButton(TabContent, text, cb) end
        function Tab:AddLabel(text)        return CreateLabel(TabContent, text) end
        function Tab:AddTextbox(ph, cb)    return CreateTextbox(TabContent, ph, cb) end

        function Tab:AddToggle(text, default, cb)
            local el = CreateToggle(TabContent, text, default, cb)
            Window.ConfigValues[text] = el
            return el
        end

        function Tab:AddSlider(text, min, max, default, cb)
            local el = CreateSlider(TabContent, text, min, max, default, cb)
            Window.ConfigValues[text] = el
            return el
        end

        function Tab:AddKeybind(text, default, cb)
            local el = CreateKeybind(TabContent, text, default, cb)
            Window.ConfigValues[text] = el   -- FIX: now saves correctly
            return el
        end

        return Tab
    end

    -- ‚îÄ‚îÄ Config Tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function Window:InitializeConfigTab()
        local ConfigTab = Window:CreateTab("Config", "‚öô")
        ConfigTab.Button.LayoutOrder = 999

        ConfigTab:AddLabel("Configuration Manager")
        local nameBox = ConfigTab:AddTextbox("Enter config name...", nil)

        -- Config list UI
        local ListFrame = Instance.new("Frame")
        ListFrame.Size             = UDim2.new(1, 0, 0, 200)
        ListFrame.BackgroundColor3 = Colors.Surface
        ListFrame.BorderSizePixel  = 0
        ListFrame.Parent           = ConfigTab.Content
        Corner(ListFrame, 8)

        local Scroll = Instance.new("ScrollingFrame")
        Scroll.Size                  = UDim2.new(1, -8, 1, -8)
        Scroll.Position              = UDim2.new(0, 4, 0, 4)
        Scroll.BackgroundTransparency= 1
        Scroll.BorderSizePixel       = 0
        Scroll.ScrollBarThickness    = 4
        Scroll.ScrollBarImageColor3  = Colors.Primary
        Scroll.CanvasSize            = UDim2.new(0, 0, 0, 0)
        Scroll.Parent                = ListFrame

        local ScrollList = Instance.new("UIListLayout")
        ScrollList.Padding   = UDim.new(0, 4)
        ScrollList.SortOrder = Enum.SortOrder.LayoutOrder
        ScrollList.Parent    = Scroll

        local ScrollPad = Instance.new("UIPadding")
        ScrollPad.PaddingTop    = UDim.new(0, 4)
        ScrollPad.PaddingLeft   = UDim.new(0, 4)
        ScrollPad.PaddingRight  = UDim.new(0, 4)
        ScrollPad.PaddingBottom = UDim.new(0, 4)
        ScrollPad.Parent        = Scroll

        ScrollList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Scroll.CanvasSize = UDim2.new(0, 0, 0, ScrollList.AbsoluteContentSize.Y + 8)
        end)

        local function Notify(text, duration)
            pcall(function()
                game.StarterGui:SetCore("SendNotification", {
                    Title = "D.R.X", Text = text, Duration = duration or 2
                })
            end)
        end

        local function RefreshList()
            for _, c in ipairs(Scroll:GetChildren()) do
                if c:IsA("Frame") then c:Destroy() end
            end
            local configs = GetConfigList()
            for _, cfgName in ipairs(configs) do
                local Item = Instance.new("Frame")
                Item.Size             = UDim2.new(1, 0, 0, 32)
                Item.BackgroundColor3 = Colors.Elevated
                Item.BorderSizePixel  = 0
                Item.Parent           = Scroll
                Corner(Item, 6)

                local NameLbl = Instance.new("TextLabel")
                NameLbl.Size           = UDim2.new(1, -80, 1, 0)
                NameLbl.Position       = UDim2.new(0, 8, 0, 0)
                NameLbl.BackgroundTransparency = 1
                NameLbl.Font           = Enum.Font.Gotham
                NameLbl.Text           = cfgName
                NameLbl.TextColor3     = Colors.TextPrimary
                NameLbl.TextSize       = 12
                NameLbl.TextXAlignment = Enum.TextXAlignment.Left
                NameLbl.Parent         = Item

                local SelBtn = Instance.new("TextButton")
                SelBtn.Size             = UDim2.new(0, 70, 0, 24)
                SelBtn.Position         = UDim2.new(1, -74, 0.5, 0)
                SelBtn.AnchorPoint      = Vector2.new(0, 0.5)
                SelBtn.BackgroundColor3 = Colors.Primary
                SelBtn.BorderSizePixel  = 0
                SelBtn.Font             = Enum.Font.GothamBold
                SelBtn.Text             = "Select"
                SelBtn.TextColor3       = Colors.TextPrimary
                SelBtn.TextSize         = 11
                SelBtn.Parent           = Item
                Corner(SelBtn, 4)

                SelBtn.MouseButton1Click:Connect(function()
                    nameBox.SetText(cfgName)
                    for _, c in ipairs(Scroll:GetChildren()) do
                        if c:IsA("Frame") then c.BackgroundColor3 = Colors.Elevated end
                    end
                    Item.BackgroundColor3 = Colors.Primary
                    Notify("Selected: " .. cfgName)
                end)
            end
        end

        -- Save
        ConfigTab:AddButton("üíæ Save Config", function()
            local name = nameBox.GetText()
            if name == "" then Notify("Enter a config name first!") return end

            local data = {}
            for key, el in pairs(Window.ConfigValues) do
                -- GetValue works on toggle, slider, and now keybind (fixed)
                local ok, val = pcall(el.GetValue)
                if ok then data[key] = val end
            end

            if SaveConfig(name, data) then
                Notify("Saved: " .. name, 3)
                task.delay(0.1, RefreshList)
            else
                Notify("Save failed! Check executor file permissions.", 4)
            end
        end)

        -- Load
        ConfigTab:AddButton("üìÇ Load Config", function()
            local name = nameBox.GetText()
            if name == "" then Notify("Select a config first!") return end

            local data = LoadConfig(name)
            if not data then Notify("Failed to load config!") return end

            -- First pass: set all values silently
            for key, el in pairs(Window.ConfigValues) do
                if data[key] ~= nil then
                    pcall(el.SetValue, data[key], false)
                end
            end

            -- Second pass: fire all callbacks so game settings actually apply
            task.wait(0.05)
            for key, el in pairs(Window.ConfigValues) do
                if data[key] ~= nil then
                    pcall(el.TriggerCallback)
                end
            end

            Notify("Loaded: " .. name, 3)
        end)

        -- Delete
        ConfigTab:AddButton("üóë Delete Config", function()
            local name = nameBox.GetText()
            if name == "" then Notify("Select a config first!") return end
            if DeleteConfig(name) then
                nameBox.Clear()
                Notify("Deleted: " .. name, 3)
                task.delay(0.05, RefreshList)
            else
                Notify("Delete failed!")
            end
        end)

        ConfigTab:AddLabel("Keybinds")
        local toggleKey = ConfigTab:AddKeybind("Toggle GUI", "RightShift", nil)
        Window.ToggleKey = toggleKey

        RefreshList()

        -- Make sure first real tab stays selected after config tab added
        task.wait(0.05)
        for _, t in ipairs(Window.Tabs) do
            t.Content.Visible = false
        end
        if Window.Tabs[1] then
            Window.Tabs[1].Button.BackgroundTransparency = 0
            Window.Tabs[1].Button.TextColor3 = Colors.TextPrimary
            Window.Tabs[1].Content.Visible = true
        end
    end

    -- Dragging
    local dragging, dragStart, startPos = false, nil, nil
    TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging  = true
            dragStart = input.Position
            startPos  = Main.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local d = input.Position - dragStart
            Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset+d.X, startPos.Y.Scale, startPos.Y.Offset+d.Y)
        end
    end)

    -- Toggle visibility keybind
    UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        if Window.ToggleKey and input.KeyCode.Name == Window.ToggleKey.GetKey() then
            Main.Visible = not Main.Visible
        end
    end)

    -- Entrance animation
    Main.BackgroundTransparency  = 1
    TopBar.BackgroundTransparency= 1
    Sidebar.BackgroundTransparency=1
    for _, c in ipairs(Main:GetDescendants()) do
        if c:IsA("TextLabel") or c:IsA("TextButton") then c.TextTransparency = 1 end
    end
    Tween(Main,    {BackgroundTransparency=0}, 0.3)
    Tween(TopBar,  {BackgroundTransparency=0}, 0.3)
    Tween(Sidebar, {BackgroundTransparency=0}, 0.3)
    task.wait(0.1)
    for _, c in ipairs(Main:GetDescendants()) do
        if c:IsA("TextLabel") or c:IsA("TextButton") then Tween(c, {TextTransparency=0}, 0.3) end
    end

    Window.Main = Main
    return Window
end

return Library
